<div class="email-wrapper" style="margin-left: {% if level > 0 %}{{ level }}rem{% else %}0{% endif %};">

  <div id="email-{{ node.email.id }}" class="email-section">
    <div class="email-header">
      <div class="email-meta">
        <strong>ID письма:</strong> {{ node.email.id }}
        {% if node.references %}
          <small class="email-links">
            [ответ на:
            {% for ref in node.references %}
              <a class="email-link" href="#email-{{ ref.id }}">{{ ref.id }}</a>{% if not forloop.last %}, {% else %}]{% endif %}
            {% endfor %}
          </small>
        {% endif %}
      </div>
  
      <div class="email-from">
        <strong>От:</strong> <span class="copy-text" data-text="{{ node.email.email_from }}">{{ node.email.email_from }}</span>
      </div>
    
      <div class="email-to">
        <strong>Кому:</strong>
        {% for to in node.email.email_msg_to.all %}
          {{ to.email_to }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      </div>
  
      {% if node.email.email_msg_cc.exists %}
        <div class="email-to-cc">
          <strong>Копия:</strong>
          {% for cc in node.email.email_msg_cc.all %}
            {{ cc.email_to }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </div>
      {% endif %}
  
      <div class="email-date"><strong>Дата:</strong> {{ node.email.email_date|date:"d.m.Y H:i" }}</div>
  
    </div>
  
    <div class="email-subject">
      {% if node.email.email_subject %}
        <strong class="copy-text" data-text="{{ node.email.email_subject }}">{{ node.email.email_subject }}</strong>
      {% else %}
        <strong>Без темы</strong>
      {% endif %}
    </div>
  
    <div class="email-body">
      {{ node.email.email_body|linebreaks }}
    </div>
  
    {% if node.email.email_attachments.exists or node.email.email_intext_attachments.exists %}
    <div class="email-attachments-wrapper">
      <button type="button" class="toggle-attachments-btn" onclick="this.nextElementSibling.classList.toggle('hidden'); this.textContent = this.nextElementSibling.classList.contains('hidden') ? 'Показать вложения' : 'Скрыть вложения';">
        Показать вложения
      </button>
      <div class="email-attachments hidden">
        <ul>
          {% for att in node.email.email_attachments.all %}
            <li class="attachment-item">
              <a href="{{ att.file_url.url }}" target="_blank" class="attachment-file">
                {% if att.file_name|lower|slice:"-4:" in ".jpg.png.gif" or att.file_name|lower|slice:"-5:" == ".jpeg" %}
                  <span class="attachment-preview" style="background-image: url('{{ att.file_url.url }}');"></span>
                {% else %}
                  <span class="attachment-icon
                    {% if att.file_name|lower|slice:"-4:" == ".pdf" %}pdf
                    {% elif att.file_name|lower|slice:"-5:" == ".xlsx" %}xlsx
                    {% elif att.file_name|lower|slice:"-5:" == ".docx" %}docx
                    {% elif att.file_name|lower|slice:"-4:" == ".txt" %}txt
                    {% else %}file{% endif %}"></span>
                {% endif %}
                  <p class="attachment-name">{{ att.file_name }}</p>
              </a>
            </li>
          {% endfor %}
          {% for att in node.email.email_intext_attachments.all %}
            <li class="attachment-item">
              <a href="{{ att.file_url.url }}" target="_blank" class="attachment-file">
                {% if att.file_name|lower|slice:"-4:" in ".jpg.png.gif" or att.file_name|lower|slice:"-5:" == ".jpeg" %}
                  <span class="attachment-preview" style="background-image: url('{{ att.file_url.url }}');"></span>
                {% else %}
                  <span class="attachment-icon
                    {% if att.file_name|lower|slice:"-4:" == ".pdf" %}pdf
                    {% elif att.file_name|lower|slice:"-5:" == ".xlsx" %}xlsx
                    {% elif att.file_name|lower|slice:"-5:" == ".docx" %}docx
                    {% elif att.file_name|lower|slice:"-4:" == ".txt" %}txt
                    {% else %}file{% endif %}"></span>
                {% endif %}
                  <p class="attachment-name">{{ att.file_name }}</p>
              </a>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}
  </div>

  {% if node.children %}
    <div class="email-children">
      {% for child in node.children %}
        {% include "incidents/includes/email_node.html" with node=child level=level|add:2 %}
      {% endfor %}
    </div>
  {% endif %}
</div>
