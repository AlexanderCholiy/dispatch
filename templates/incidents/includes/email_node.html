<div class="email-wrapper">

  <div id="email-{{ node.email.id }}" class="email-content">
    <div class="email-left">
      <div class="email-subject">
        {% if node.email.email_subject %}
          <strong class="copy-text" data-text="{{ node.email.email_subject }}">{{ node.email.email_subject }}</strong>
        {% else %}
          <strong>Без темы</strong>
        {% endif %}
      </div>
    
      <div class="email-body">
        {{ node.email.email_body|linebreaks }}
      </div>
    
      <div class="email-attachments-wrapper">
        {% if node.email.email_attachments.all or node.email.email_intext_attachments.all %}
          <button type="button" class="toggle-attachments-btn" onclick="this.nextElementSibling.classList.toggle('hidden'); this.textContent = this.nextElementSibling.classList.contains('hidden') ? 'Показать вложения' : 'Скрыть вложения';">
            Показать вложения
          </button>
          <div class="email-attachments hidden">
            <ul>
              {% for att in node.email.email_attachments.all %}
                <li class="attachment-item">
                  <a href="{{ att.file_url.url }}" target="_blank" class="attachment-file">
                    {% if att.file_name|lower|slice:"-4:" in ".jpg.png.gif" or att.file_name|lower|slice:"-5:" == ".jpeg" %}
                      <span class="attachment-preview" style="background-image: url('{{ att.file_url.url }}');"></span>
                    {% else %}
                      <span class="attachment-icon
                        {% if att.file_name|lower|slice:"-4:" == ".pdf" %}pdf
                        {% elif att.file_name|lower|slice:"-5:" == ".xlsx" %}xlsx
                        {% elif att.file_name|lower|slice:"-5:" == ".docx" %}docx
                        {% elif att.file_name|lower|slice:"-4:" == ".txt" %}txt
                        {% else %}file{% endif %}"></span>
                    {% endif %}
                      <p class="attachment-name">{{ att.file_name }}</p>
                  </a>
                </li>
              {% endfor %}
              {% for att in node.email.email_intext_attachments.all %}
                <li class="attachment-item">
                  <a href="{{ att.file_url.url }}" target="_blank" class="attachment-file">
                    {% with att.file_name|lower as fname %}
                      {% if fname|slice:"-4:" in ".jpg.png.gif" or fname|slice:"-5:" == ".jpeg" or fname|slice:"-5:" == ".webp" or fname|slice:"-4:" == ".bmp" or fname|slice:"-4:" == ".svg" or fname|slice:"-5:" == ".jfif" %}
                      <img src="{{ att.file_url.url }}" 
                          alt="{{ att.file_name }}" 
                          class="attachment-preview" 
                          onerror="this.onerror=null; this.outerHTML='<i class=\'bx bx-image\'></i>';">
                      {% else %}
                        <span class="attachment-icon
                          {% if fname|slice:"-4:" == ".pdf" %}pdf
                          {% elif fname|slice:"-5:" == ".xlsx" %}xlsx
                          {% elif fname|slice:"-4:" == ".xls" %}xlsx
                          {% elif fname|slice:"-7:" == ".gsheet" %}gsheet
                          {% elif fname|slice:"-5:" == ".docx" %}docx
                          {% elif fname|slice:"-4:" == ".doc" %}docx
                          {% elif fname|slice:"-5:" == ".gdoc" %}gdoc
                          {% elif fname|slice:"-5:" == ".pptx" %}pptx
                          {% elif fname|slice:"-4:" == ".ppt" %}pptx
                          {% elif fname|slice:"-4:" == ".txt" %}txt
                          {% elif fname|slice:"-5:" == ".json" %}json
                          {% elif fname|slice:"-4:" == ".csv" %}csv
                          {% elif fname|slice:"-5:" == ".html" %}html
                          {% elif fname|slice:"-4:" == ".zip" %}zip
                          {% elif fname|slice:"-3:" == ".7z" %}zip
                          {% elif fname|slice:"-3:" == ".gz" %}zip
                          {% elif fname|slice:"-4:" == ".rar" %}rar
                          {% elif fname|slice:"-4:" == ".tar" %}rar
                          {% elif fname|slice:"-4:" == ".mp3" %}mp3
                          {% elif fname|slice:"-4:" == ".mp4" %}video
                          {% elif fname|slice:"-4:" == ".mov" %}video
                          {% elif fname|slice:"-4:" == ".avi" %}video
                          {% elif fname|slice:"-4:" == ".mkv" %}video
                          {% elif fname|slice:"-5:" == ".webm" %}video
                          {% elif fname|slice:"-5:" == ".vsdx" %}file
                          {% elif fname|slice:"-4:" == ".vsd" %}file
                          {% elif fname|slice:"-4:" == ".odt" %}file
                          {% elif fname|slice:"-4:" == ".ods" %}file
                          {% elif fname|slice:"-4:" == ".odp" %}file
                          {% elif fname|slice:"-5:" == ".epub" %}file
                          {% elif fname|slice:"-8:" == ".gslides" %}file
                          {% elif fname|slice:"-6:" == ".gdraw" %}file
                          {% elif fname|slice:"-6:" == ".gform" %}file
                          {% elif fname|slice:"-4:" == ".rtf" %}file
                          {% elif fname|slice:"-4:" == ".bz2" %}file
                          {% elif fname|slice:"-4:" == ".mpp" %}file
                          {% elif fname|slice:"-4:" == ".mdb" %}file
                          {% elif fname|slice:"-4:" == ".wav" %}file
                          {% elif fname|slice:"-4:" == ".ogg" %}file
                          {% else %}file{% endif %}">
                        </span>
                      {% endif %}
                    {% endwith %}
                    <p class="attachment-name">{{ att.file_name }}</p>
                  </a>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="email-right">
      
      <div class="email-from">
        <strong>От:</strong> <span class="copy-text" data-text="{{ node.email.email_from }}">{{ node.email.email_from }}</span>
      </div>
      
      <div class="email-to">
        <strong>Кому:</strong>
        {% for to in node.email.email_msg_to.all %}
        {{ to.email_to }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      </div>
      
      {% if node.email.email_msg_cc.all %}
        <div class="email-to-cc">
          <strong>Копия:</strong>
          {% for cc in node.email.email_msg_cc.all %}
          {{ cc.email_to }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </div>
      {% endif %}
      
      <div class="email-date"><strong>Дата:</strong>{{ node.email.email_date|date:"d.m.Y H:i" }}</div>

      <div class="email-meta-id"><strong>ID письма:</strong>{{ node.email.id }}</div>
      {% if node.references %}
        <div class="email-meta-ref">
          <strong>Ответ на:</strong> 
          {% for ref in node.references %}
            <a class="email-link" href="#email-{{ ref.id }}">{{ ref.id }}</a>{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </div>  
  </div>

  {% if node.children %}
    <div class="email-children">
      {% for child in node.children %}
        {% include "incidents/includes/email_node.html" with node=child level=level|add:1 %}
      {% endfor %}
    </div>
  {% endif %}
</div>